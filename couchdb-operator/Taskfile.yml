version: '3'

vars:
  NAMESPACE: openserverless-system
  IMAGE: couchdb-operator:latest

tasks:
  default:
    desc: "ğŸ”¥ Builda, importa, deploya e applica tutto"
    cmds:
      - task: run



  build-and-load:
    desc: "ğŸ”¨ Build e import immagine nel MicroK8s (containerd)"
    cmds:
      - echo "ğŸ”§ Costruisco l'immagine Docker..."
      - docker build --no-cache -t {{.IMAGE}} -f Dockerfile .
      - echo "ğŸ“¦ Salvataggio immagine su file tar..."
      - docker save {{.IMAGE}} -o /tmp/couchdb-operator.tar
      - echo "ğŸ“¥ Import nel containerd di MicroK8s..."
      - sudo microk8s ctr image import /tmp/couchdb-operator.tar




  run:
    desc: "ğŸ” Ricompila, importa, deploya, crea e monitora tutto"
    cmds:
      - task: build-and-load
      - task: reload
      - task: apply-crd-and-instance
      - task: logs

  test-reapply:
    desc: "â™»ï¸ Ricarica l'immagine e riapplica la risorsa esistente"
    cmds:
      - task: build-and-load
      - task: reload
      - task: apply-crd-and-instance
      - task: logs


  build:
    desc: "ğŸ›  Costruisce immagine Docker dell'operatore"
    cmds:
      - docker build -t {{.IMAGE}} -f Dockerfile .

  push:
    desc: "ğŸ“¦ Importa immagine nel containerd di MicroK8s"
    cmds:
      - docker save {{.IMAGE}} -o /tmp/couchdb-operator.tar
      - sudo microk8s ctr image import /tmp/couchdb-operator.tar

  reload:
    desc: "â™»ï¸ Ricarica operatore (pod + deployment)"
    cmds:
      - kubectl delete pod -n {{.NAMESPACE}} -l app=couchdb-operator --ignore-not-found
      - kubectl apply -f deployment.yaml

  apply-crd-and-instance:
    desc: "ğŸ“œ Applica CRD + Istanza"
    cmds:
      - kubectl apply -f couchdb-crd.yaml
      - kubectl apply -f couchdb-instance.yaml -n {{.NAMESPACE}}

  logs:
    desc: "ğŸ§¾ Mostra i log dell'operatore"
    cmds:
      - kubectl logs -n {{.NAMESPACE}} -l app=couchdb-operator -f

  jobs-status:
    desc: "ğŸ” Verifica i Job CouchDB e i relativi pod"
    cmds:
      - echo "ğŸ“¦ Job nel namespace openserverless-system:"
      - kubectl get jobs -n openserverless-system | grep couchdb-init || echo "âŒ Nessun Job trovato"
      - echo "ğŸ“¦ Pod associati allâ€™ultimo Job couchdb-init:"
      - |
        job=$(kubectl get jobs -n openserverless-system --no-headers | grep couchdb-init | awk '{print $1}' | tail -n1)
        if [ -n "$job" ]; then
          kubectl get pods -n openserverless-system -l job-name=$job || echo "âŒ Nessun pod trovato per il job $job"
        else
          echo "âŒ Nessun Job trovato"
        fi
      - echo "ğŸ“„ Log del container init-couchdb (se presente):"
      - |
        job=$(kubectl get jobs -n openserverless-system --no-headers | grep couchdb-init | awk '{print $1}' | tail -n1)
        if [ -n "$job" ]; then
          pod=$(kubectl get pods -n openserverless-system -l job-name=$job -o jsonpath="{.items[0].metadata.name}" 2>/dev/null || echo "")
          if [ -n "$pod" ]; then
            kubectl logs -n openserverless-system "$pod" -c init-couchdb || echo "âŒ Log non disponibile"
          else
            echo "âŒ Nessun pod trovato per il job $job"
          fi
        else
          echo "âŒ Nessun Job trovato"
        fi


  show-objects:
    desc: "ğŸ“‹ Mostra le risorse create dall'operatore nel namespace nuvolaris"
    cmds:
      - echo "ğŸ“Œ StatefulSet:"
      - kubectl get statefulset -n nuvolaris -o wide
      - echo ""
      - echo "ğŸ” Secret:"
      - kubectl get secret -n nuvolaris | grep couchdb-auth || echo "âŒ Nessun secret trovato"
      - echo ""
      - echo "ğŸ§ª Job:"
      - kubectl get job -n nuvolaris
      - echo ""
      - echo "ğŸ“¦ Pod:"
      - kubectl get pods -n nuvolaris -o wide
      - echo ""
      - echo "ğŸ“„ Log del job init-couchdb (se esiste):"
      - |
        pod=$(kubectl get pods -n nuvolaris -l job-name=couchdb-init -o jsonpath="{.items[0].metadata.name}" 2>/dev/null || echo "")
        if [ -n "$pod" ]; then
          kubectl logs -n nuvolaris "$pod" -c init-couchdb || true
        else
          echo "âŒ Nessun pod init-couchdb trovato"
        fi




  verify:
    desc: Verifica che tutti gli oggetti CouchDB siano presenti e funzionanti
    cmds:
      - echo "ğŸ” Verifica Secret nel namespace 'nuvolaris'..."
      - kubectl get secret -n nuvolaris | grep couchdb-auth || echo "âŒ Secret mancante"

      - echo "ğŸ” Verifica StatefulSet nel namespace 'nuvolaris'..."
      - kubectl get statefulset -n nuvolaris | grep couchdb || echo "âŒ StatefulSet mancante"

      - echo "ğŸ” Verifica Job nel namespace 'nuvolaris'..."
      - kubectl get jobs -n nuvolaris | grep couchdb-init || echo "âŒ Nessun Job trovato"

      - echo "ğŸ” Verifica pod di CouchDB (nuvolaris)..."
      - kubectl get pods -n nuvolaris -l app=nuvolaris-couchdb -o wide

      - echo "ğŸ” Verifica pod dellâ€™ultimo Job couchdb-init..."
      - |
        job=$(kubectl get jobs -n nuvolaris --sort-by=.metadata.creationTimestamp --no-headers | grep couchdb-init | tail -n1 | awk '{print $1}')
        if [ -n "$job" ]; then
          pod=$(kubectl get pods -n nuvolaris --sort-by=.metadata.creationTimestamp --no-headers | grep "$job" | head -n1 | awk '{print $1}')
          if [ -n "$pod" ]; then
            echo "âœ… Pod trovato: $pod"
            kubectl get pod -n nuvolaris "$pod" -o wide
          else
            echo "âŒ Nessun pod trovato per il job $job"
          fi
        else
          echo "âŒ Nessun Job trovato"
        fi

      - echo "ğŸ” Verifica stato completamento del Job..."
      - |
        job=$(kubectl get jobs -n nuvolaris --sort-by=.metadata.creationTimestamp --no-headers | grep couchdb-init | tail -n1 | awk '{print $1}')
        if [ -n "$job" ]; then
          status=$(kubectl get job "$job" -n nuvolaris -o jsonpath="{.status.succeeded}" 2>/dev/null)
          if [ "$status" = "1" ]; then
            echo "âœ… Job completato con successo"
          else
            echo "âŒ Job non completato"
          fi
        else
          echo "âŒ Job non trovato"
        fi

      - echo "ğŸ“„ Log del container 'init-couchdb' del Job..."
      - |
        job=$(kubectl get jobs -n nuvolaris --sort-by=.metadata.creationTimestamp --no-headers | grep couchdb-init | tail -n1 | awk '{print $1}')
        pod=$(kubectl get pods -n nuvolaris --sort-by=.metadata.creationTimestamp --no-headers | grep "$job" | head -n1 | awk '{print $1}')
        if [ -n "$pod" ]; then
          kubectl logs -n nuvolaris "$pod" -c init-couchdb || echo "âŒ Log non disponibile"
        else
          echo "âŒ Nessun pod trovato per il job $job"
        fi

      - echo "ğŸ“„ Log del container 'check-couchdb' (initContainer)..."
      - |
        job=$(kubectl get jobs -n nuvolaris --sort-by=.metadata.creationTimestamp --no-headers | grep couchdb-init | tail -n1 | awk '{print $1}')
        pod=$(kubectl get pods -n nuvolaris --sort-by=.metadata.creationTimestamp --no-headers | grep "$job" | head -n1 | awk '{print $1}')
        if [ -n "$pod" ]; then
          kubectl logs -n nuvolaris "$pod" -c check-couchdb || echo "âŒ Log non disponibile"
        else
          echo "âŒ Nessun pod trovato per il job $job"
        fi

      - echo "ğŸŒ Test HTTP al servizio CouchDB nel cluster..."
      - |
        kubectl delete pod curlpod -n nuvolaris --ignore-not-found
        kubectl run curlpod --rm -i --tty -n nuvolaris --image=curlimages/curl --restart=Never -- \
          curl -sf http://couchdb.nuvolaris.svc.cluster.local:5984 || echo "âŒ Servizio non raggiungibile"

  

  build-dbinit:
    desc: Costruisce e carica l'immagine per il job couchdb-init
    cmds:
      - echo "ğŸ—ï¸  Costruzione immagine couchdb-init-job..."
      - docker build -t couchdb-init-job:latest -f Dockerfile.dbinit .
      - echo "ğŸ“¦  Salvataggio immagine su file..."
      - docker save couchdb-init-job:latest > dbinit.tar
      - echo "ğŸ“¤  Import dell'immagine in MicroK8s containerd..."
      - microk8s ctr images import dbinit.tar



